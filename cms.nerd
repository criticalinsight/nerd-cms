-- ============================================================================
-- NERD CMS - Content Management System in Pure NERD
-- A minimalist CMS running on Cloudflare Workers via WebAssembly
-- Theme: Anemone-inspired (based on anemone.pages.dev screenshots)
-- ============================================================================

-- ============================================================================
-- CSS Theme (Anemone-inspired - matches anemone.pages.dev exactly)
-- ============================================================================

fn render_css
  out "<style>"
  -- Root variables - Anemone light theme
  out ":root{--bg:#f5f5f5;--bg-secondary:#e8e8e8;--text:#333;--text-secondary:#666;--accent:#e91e63;--accent-hover:#c2185b;--border:#ddd;--font-sans:'Segoe UI',system-ui,sans-serif;--font-mono:'JetBrains Mono','Fira Code',ui-monospace,monospace;--spacing-sm:.5rem;--spacing-md:1rem;--spacing-lg:1.5rem;--max-width:48rem}"
  -- Dark theme
  out "@media(prefers-color-scheme:dark){:root{--bg:#1a1a1a;--bg-secondary:#252525;--text:#d4d4d4;--text-secondary:#888;--accent:#ff4081;--accent-hover:#ff80ab;--border:#333}}"
  out "[data-theme=dark]{--bg:#1a1a1a;--bg-secondary:#252525;--text:#d4d4d4;--text-secondary:#888;--accent:#ff4081;--accent-hover:#ff80ab;--border:#333}"
  out "[data-theme=light]{--bg:#f5f5f5;--bg-secondary:#e8e8e8;--text:#333;--text-secondary:#666;--accent:#e91e63;--accent-hover:#c2185b;--border:#ddd}"
  -- Reset and base
  out "*{box-sizing:border-box;margin:0;padding:0}"
  out "html{font-size:16px;scroll-behavior:smooth}"
  out "body{font-family:var(--font-sans);line-height:1.8;color:var(--text);background:var(--bg);min-height:100vh}"
  out ".container{max-width:var(--max-width);margin:0 auto;padding:var(--spacing-lg) var(--spacing-md)}"
  -- Typography - Anemone style with # prefix
  out "h1,h2,h3{font-family:var(--font-mono);font-weight:400;line-height:1.4;margin:var(--spacing-lg) 0 var(--spacing-md)}"
  out "h1::before{content:'# ';color:var(--text-secondary)}"
  out "h2::before{content:'# ';color:var(--text-secondary)}"
  out "h3::before{content:'## ';color:var(--text-secondary)}"
  out "h1{font-size:1.5rem}h2{font-size:1.25rem}h3{font-size:1.1rem}"
  out "h1:first-child{margin-top:0}"
  out "p{margin-bottom:var(--spacing-md)}"
  -- Links - Anemone pink accent
  out "a{color:var(--accent);text-decoration:none}"
  out "a:hover{text-decoration:underline}"
  -- Code
  out "code{background:var(--bg-secondary);padding:.2em .4em;border-radius:3px;font-family:var(--font-mono);font-size:.9em}"
  out "pre{background:var(--bg-secondary);padding:var(--spacing-md);border-radius:4px;overflow-x:auto;margin:var(--spacing-md) 0}"
  out "pre code{background:none;padding:0}"
  -- Lists - Anemone style with arrow markers
  out "ul,ol{margin:var(--spacing-sm) 0;padding-left:var(--spacing-lg)}"
  out "li{margin-bottom:.25rem;position:relative}"
  out "ul{list-style:none;padding-left:1.5rem}"
  out "ul>li::before{content:'Â»';position:absolute;left:-1.25rem;color:var(--text-secondary)}"
  -- Blockquote - left border style
  out "blockquote{border-left:3px solid var(--border);margin:var(--spacing-md) 0;padding:var(--spacing-sm) var(--spacing-md);color:var(--text-secondary);font-style:italic}"
  -- Navigation - Anemone slash style
  out "nav{text-align:center;padding:var(--spacing-md) 0;font-family:var(--font-mono);font-size:.9rem}"
  out "nav a{color:var(--text-secondary);margin:0 .25rem}"
  out "nav a:hover{color:var(--accent)}"
  out "nav a.active{color:var(--accent)}"
  out ".nav-sep{color:var(--text-secondary)}"
  -- Footer - minimal
  out "footer{margin-top:var(--spacing-lg);padding:var(--spacing-md) 0;border-top:1px solid var(--border);text-align:center;font-size:.875rem;color:var(--text-secondary)}"
  out "footer a{color:var(--accent)}"
  -- Theme toggle - sun/moon
  out ".theme-toggle{position:fixed;top:var(--spacing-md);right:var(--spacing-md);background:none;border:none;cursor:pointer;font-size:1.25rem;opacity:.6}"
  out ".theme-toggle:hover{opacity:1}"
  -- Articles and sections
  out "article{margin-bottom:var(--spacing-lg)}"
  out "section{margin:var(--spacing-lg) 0}"
  -- Tables - Anemone style
  out "table{width:100%;border-collapse:collapse;margin:var(--spacing-md) 0;font-size:.9rem}"
  out "th,td{padding:.5rem;text-align:left;border-bottom:1px solid var(--border)}"
  out "th{font-weight:600;background:var(--bg-secondary)}"
  -- Utilities
  out ".text-secondary{color:var(--text-secondary)}"
  out ".text-center{text-align:center}"
  out ".mt-lg{margin-top:var(--spacing-lg)}"
  out ".list-plain{list-style:none;padding-left:0}"
  out ".list-plain li::before{content:none}"
  -- Responsive
  out "@media(max-width:640px){.container{padding:var(--spacing-md)}}"
  out "</style>"

-- ============================================================================
-- HTML Document Structure
-- ============================================================================

fn render_head title
  out "<!DOCTYPE html>"
  out "<html lang=\"en\">"
  out "<head>"
  out "<meta charset=\"UTF-8\">"
  out "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
  out "<meta name=\"description\" content=\"Powered by NERD CMS\">"
  out "<meta name=\"generator\" content=\"NERD CMS\">"
  out "<title>"
  out title
  out " | nerd cms</title>"
  call render_css

fn render_header
  out "</head>"
  out "<body>"
  out "<div class=\"container\">"
  -- Anemone-style navigation with slashes
  out "<nav>"
  out "<a href=\"/\">/home/</a>"
  out "<a href=\"/about\">/about/</a>"
  out "<a href=\"/blog\">/blog/</a>"
  out "<a href=\"/plugins\">/plugins/</a>"
  out "â˜€"
  out "</nav>"
  out "<main>"

fn render_footer
  out "</main>"
  out "<footer>"
  out "Made using <a href=\"https://nerd-lang.org\">nerd</a> cms"
  out "</footer>"
  out "</div>"
  out "<button class=\"theme-toggle\" onclick=\"toggleTheme()\" aria-label=\"Toggle theme\">â˜€</button>"
  out "<script>"
  out "(function(){var t=localStorage.getItem('theme')||(window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light');document.documentElement.setAttribute('data-theme',t);document.querySelector('.theme-toggle').textContent=t==='dark'?'â˜€':'â„'})();"
  out "function toggleTheme(){var h=document.documentElement,c=h.getAttribute('data-theme')||'light',n=c==='dark'?'light':'dark';h.setAttribute('data-theme',n);localStorage.setItem('theme',n);document.querySelector('.theme-toggle').textContent=n==='dark'?'â˜€':'â„'}"
  out "</script>"
  out "</body>"
  out "</html>"

-- ============================================================================
-- Page: Home
-- ============================================================================

fn render_home
  call render_head "Home"
  call render_header
  out "<article>"
  out "<h1>Overview</h1>"
  out "<p>nerd cms is designed to provide a nearly no-JavaScript, efficient, and minimalist experience for your website. Embracing simplicity, the theme focuses on content and readability.</p>"
  out "<blockquote>\"Simplicity is a prerequisite for reliability.\" â€” Rich Hickey</blockquote>"
  out "<h2>Features</h2>"
  out "<ul>"
  out "<li>âš¡ Edge computing on Cloudflare Workers</li>"
  out "<li>ğŸ¨ Anemone-inspired minimalist theme</li>"
  out "<li>ğŸŒ™ Dark/light mode with system preference</li>"
  out "<li>ğŸ“ Markdown content with KV storage</li>"
  out "<li>ğŸ”§ 100% NERD â€” minimal JavaScript</li>"
  out "</ul>"
  out "<h2>Blog Posts</h2>"
  out "<p>Explore our content:</p>"
  out "<ul>"
  out "<li>ğŸ“ <a href=\"/blog/hello-world\">Hello World</a></li>"
  out "<li>ğŸ§  <a href=\"/blog/rich-hickey-principles\">Rich Hickey Principles</a></li>"
  out "</ul>"
  out "<h2>Links</h2>"
  out "<ul>"
  out "<li>Code: <a href=\"https://github.com/criticalinsight/nerd-cms\">GitHub</a></li>"
  out "<li>Language: <a href=\"https://nerd-lang.org\">nerd-lang.org</a></li>"
  out "</ul>"
  out "</article>"
  call render_footer

-- ============================================================================
-- Page: About
-- ============================================================================

fn render_about
  call render_head "About"
  call render_header
  out "<article>"
  out "<h1>About</h1>"
  out "<p>nerd cms is a content management system built with the <strong>NERD programming language</strong> and compiled to WebAssembly for deployment on Cloudflare Workers.</p>"
  out "<h2>Technology Stack</h2>"
  out "<ul>"
  out "<li>ğŸ”¤ <a href=\"https://nerd-lang.org\">NERD</a> â€” Machine-authored intermediate language</li>"
  out "<li>ğŸ”· <a href=\"https://webassembly.org\">WebAssembly</a> â€” Portable binary format</li>"
  out "<li>â˜ï¸ <a href=\"https://workers.cloudflare.com\">Cloudflare Workers</a> â€” Edge computing</li>"
  out "</ul>"
  out "<h2>Philosophy</h2>"
  out "<p>Following Rich Hickey's principles:</p>"
  out "<ul>"
  out "<li>Simple over easy</li>"
  out "<li>Data over objects</li>"
  out "<li>Composition over complection</li>"
  out "</ul>"
  out "</article>"
  call render_footer

-- ============================================================================
-- Page: Plugins
-- ============================================================================

fn render_plugins
  call render_head "Plugins"
  call render_header
  out "<article>"
  out "<h1>Plugins</h1>"
  out "<p>nerd cms plugin system â€” all implemented in NERD.</p>"
  out "<h2>Built-in Plugins</h2>"
  out "<ul>"
  out "<li>ğŸ“Š <strong>Analytics</strong> â€” Request timing</li>"
  out "<li>ğŸ” <strong>SEO</strong> â€” Open Graph meta tags</li>"
  out "<li>ğŸ“„ <strong>Markdown</strong> â€” Content transformation</li>"
  out "<li>ğŸ”’ <strong>Security</strong> â€” Response headers</li>"
  out "</ul>"
  out "<h2>Available Hooks</h2>"
  out "<ul>"
  out "<li><code>request:start</code> â€” Before request processing</li>"
  out "<li><code>request:end</code> â€” After response is ready</li>"
  out "<li><code>content:load</code> â€” When content is loaded</li>"
  out "<li><code>template:after</code> â€” After template render</li>"
  out "</ul>"
  out "<h2>API</h2>"
  out "<p>Get plugins as JSON:</p>"
  out "<pre><code>GET /api/plugins</code></pre>"
  out "</article>"
  call render_footer

-- ============================================================================
-- Page: 404 Not Found
-- ============================================================================

fn render_404
  call render_head "Not Found"
  call render_header
  out "<article class=\"text-center\">"
  out "<h1>404</h1>"
  out "<p>Page not found.</p>"
  out "<p><a href=\"/\">â† back to home</a></p>"
  out "</article>"
  call render_footer

-- ============================================================================
-- Page: Raw Output
-- ============================================================================

fn render_raw
  out "NERD CMS"
  out "Powered by No Effort Required, Done"
  out five plus three

-- ============================================================================
-- Main Entry Point
-- ============================================================================

fn main
  call render_home
